<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Controle de Despesas — Planilha Viva (v4.8)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="color-scheme" content="light">
  <style>
    :root{color-scheme: only light;}
    *{box-sizing:border-box}
    html,body{background:#fff!important;color:#111;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow-x:hidden}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;z-index:10}
    h1{font-size:18px;margin:0;margin-right:auto}
    .badge,button{padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;color:#111}
    main{max-width:1100px;margin:0 auto;padding:12px;display:grid;gap:10px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:10px}
    label{font-size:12px;color:#333;display:block;margin-bottom:6px}
    input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;color:#111;max-width:100%}

    /* GRID DOS FILTROS: responsivo */
    .filters-grid{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(0,1fr))}
    @media (max-width:1024px){.filters-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:720px){.filters-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:480px){.filters-grid{grid-template-columns:repeat(1,minmax(0,1fr))}}

    /* GRID DO FORM: 4 col desktop / 2 col mobile */
    .form-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:900px){.form-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    textarea{min-height:42px;resize:vertical}

    /* Tabela */
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:8px;border-bottom:1px solid #eee;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
    th{position:sticky;top:0;background:#fff;z-index:5}
    .right{text-align:right}
    .muted{color:#666}
    .scroll{max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:10px;max-width:100%}
    .btn-mini{padding:6px 8px;font-size:12px;border-radius:8px}
    .actions{display:flex;gap:6px;flex-wrap:wrap}

    /* Colunas avançadas ocultas no mobile */
    .adv{}
    @media (max-width:900px){ .adv{display:none} }

    /* Cores por situação */
    tr[data-sit='pago']{background:#e6f4ea;color:#137333}
    tr[data-sit='aberto']{background:#fce8e6;color:#c5221f}
    tr[data-sit='parcial']{background:#fff8e1;color:#b26a00}
  </style>
</head>
<body>
  <header>
    <h1>Controle de Despesas — Planilha Viva (v4.8)</h1>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnSample">Carregar amostra</button>
      <button id="btnClear">Limpar planilha</button>
      <button id="btnInstall" class="badge hidden">Instalar</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="filters-grid">
        <div>
          <label>Ano</label>
          <select id="fAno"><option value="2025">2025</option></select>
        </div>
        <div>
          <label>Mês</label>
          <select id="fMes">
            <option value="">(Todos)</option>
            <option value="1">Jan</option><option value="2">Fev</option><option value="3">Mar</option>
            <option value="4">Abr</option><option value="5">Mai</option><option value="6">Jun</option>
            <option value="7">Jul</option><option value="8">Ago</option><option value="9">Set</option>
            <option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option>
          </select>
        </div>
        <div>
          <label>Empresa</label>
          <select id="fEmp"><option value="">(Todas)</option></select>
        </div>
        <div>
          <label>Situação</label>
          <select id="fSit">
            <option value="">(Todas)</option>
            <option>Aberto</option><option>Parcial</option><option>Pago</option>
          </select>
        </div>
        <div>
          <label>Pago</label>
          <select id="fPago">
            <option value="">(Todos)</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="form-grid">
        <div style="grid-column:1/-1"><strong>Novo Lançamento</strong></div>
        <div style="grid-column:1/-1">
          <label>EMPRESA</label>
          <input id="iEmpresa" placeholder="Ex.: Conta de Luz">
        </div>
        <div>
          <label>VENCIMENTO</label>
          <input id="iVenc" type="date">
        </div>
        <div>
          <label>VALOR</label>
          <input id="iValor" type="text" inputmode="decimal" value="0">
        </div>
        <div>
          <label>(-)DESC/(+)ACRES</label>
          <input id="iAcres" type="text" inputmode="decimal" value="0">
        </div>
        <div>
          <label>PAGO</label>
          <select id="iPago"><option>Não</option><option>Sim</option></select>
        </div>
        <div>
          <label>QT PARC</label>
          <input id="iParc" type="number" value="1" min="1">
        </div>
        <div>
          <label>TIPO</label>
          <input id="iTipo" placeholder="Ex.: Boleto">
        </div>
        <div>
          <label>SITUAÇÃO</label>
          <select id="iSit"><option>Aberto</option><option>Parcial</option><option>Pago</option></select>
        </div>
        <div>
          <label>REFERÊNCIA</label>
          <input id="iRef" placeholder="Ex.: OUT/2025">
        </div>
        <div style="grid-column:1/-1">
          <label>OBSERVAÇÃO</label>
          <textarea id="iObs" placeholder="Opcional"></textarea>
        </div>
        <div><button id="btnAdd">Adicionar</button></div>
      </div>
    </section>

    <section class="card">
      <div class="scroll">
        <table id="tbl">
          <colgroup>
            <col style="width:100px"><col style="width:180px"><col style="width:100px">
            <col style="width:110px"><col style="width:100px"><col style="width:90px"><col style="width:90px">
            <col class="adv" style="width:120px"><col class="adv" style="width:160px"><col class="adv" style="width:120px"><col style="width:140px">
          </colgroup>
          <thead>
            <tr>
              <th>Vencimento</th><th>Empresa</th><th class="right">Valor</th>
              <th class="right">(-)Desc/(+)Acres</th><th class="right">Saldo</th>
              <th>Situação</th><th>Pago</th><th class="adv">Qt Parc</th>
              <th class="adv">Obs</th><th class="adv">Tipo</th><th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">Dica: toque em <em>Editar</em> para alterar direto na planilha e <em>Salvar</em> para gravar. Tudo fica guardado no aparelho.</div>
    </section>
  </main>

  <script>
  // PWA
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('btnInstall').classList.remove('hidden'); });
  document.getElementById('btnInstall').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; document.getElementById('btnInstall').classList.add('hidden'); });
  if ('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

  // Estado
  let rows = [];
  let autoId = 1;
  const tbody = document.querySelector('#tbl tbody');

  // Utils
  function toNumber(v){ if(v==null) return 0; let s=(''+v).trim(); if(!s) return 0; if(/^[-+]?\d{1,3}(\.\d{3})*,\d{1,2}$/.test(s)) s=s.replace(/\./g,'').replace(',', '.'); s=s.replace(',', '.'); const n=parseFloat(s); return isNaN(n)?0:n; }
  function currency(n){ return (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function parseDate(d){ if(!d) return null; let s=(''+d).trim(); let dt=new Date(s); if(!isNaN(dt)) return dt; const m1=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m1) return new Date(+m1[1],+m1[2]-1,+m1[3]); const m2=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m2) return new Date(+m2[3],+m2[2]-1,+m2[1]); return null; }
  function fmt(d){ return d? d.toLocaleDateString('pt-BR'):''; }
  function id(){ return autoId++; }
  function saveLocal(){ try{ localStorage.setItem('cc_v48_rows', JSON.stringify(rows)); }catch(e){} }
  function loadLocal(){ try{ const c=localStorage.getItem('cc_v48_rows'); if(c) rows=JSON.parse(c)||[]; autoId=Math.max(1,...rows.map(r=>r._id||0))+1; }catch(e){} }

  // Filtros
  const fAno = document.getElementById('fAno');
  const fMes = document.getElementById('fMes');
  const fEmp = document.getElementById('fEmp');
  const fSit = document.getElementById('fSit');
  const fPago = document.getElementById('fPago');
  [fAno,fMes,fEmp,fSit,fPago].forEach(el=> el.addEventListener('change', render));

  function refreshFilterOptions(){
    const yNow = new Date().getFullYear();
    let anos = Array.from(new Set(rows.map(r=>r._ano).filter(Boolean)));
    if (!anos.includes(yNow)) anos.push(yNow);
    anos.sort((a,b)=>b-a);
    fAno.innerHTML = anos.map(a=>`<option ${a===yNow?'selected':''}>${a}</option>`).join('');

    const empresas = Array.from(new Set(rows.map(r=>r.EMPRESA).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    fEmp.innerHTML = '<option value="">(Todas)</option>' + empresas.map(e=>`<option>${e}</option>`).join('');
  }

  // Renderização da tabela com edição inline
  function render(){
    refreshFilterOptions();
    const ano = fAno.value? +fAno.value : null;
    const mes = fMes.value? +fMes.value : null;
    const emp = fEmp.value || null;
    const sit = fSit.value || null;
    const pago = fPago.value || null;

    const filtered = rows.filter(r=>{
      if (ano && r._ano!==ano) return false;
      if (mes && r._mes!==mes) return false;
      if (emp && r.EMPRESA!==emp) return false;
      if (sit && (r.SITUACAO||'')!==sit) return false;
      if (pago && (r.PAGO||'')!==pago) return false;
      return true;
    }).sort((a,b)=> (a.VENCIMENTO - b.VENCIMENTO) || a.EMPRESA.localeCompare(b.EMPRESA,'pt-BR'));

    tbody.innerHTML='';
    const frag=document.createDocumentFragment();
    for(const r of filtered){
      const tr=document.createElement('tr');
      tr.dataset.id = r._id;
      tr.dataset.sit = (r.SITUACAO||'').toLowerCase();
      tr.innerHTML = rowHtml(r);
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  function rowHtml(r){
    const d = fmt(r.VENCIMENTO);
    return `
      <td data-k="VENCIMENTO">${d}</td>
      <td data-k="EMPRESA">${r.EMPRESA||''}</td>
      <td class="right" data-k="VALOR">${currency(r.VALOR)}</td>
      <td class="right" data-k="ACRES">${currency(r.ACRES||0)}</td>
      <td class="right" data-k="SALDO">${currency(r.SALDO||0)}</td>
      <td data-k="SITUACAO">${r.SITUACAO||''}</td>
      <td data-k="PAGO">${r.PAGO||''}</td>
      <td class="adv" data-k="QTPARC">${r.QTPARC||''}</td>
      <td class="adv" data-k="OBS" title="${r.OBS||''}">${(r.OBS||'').slice(0,25)}</td>
      <td class="adv" data-k="TIPO">${r.TIPO||''}</td>
      <td class="actions">
        <button class="btn-mini" onclick="editRow(${r._id})">Editar</button>
        <button class="btn-mini" onclick="delRow(${r._id})">Excluir</button>
        <button class="btn-mini" onclick="markPaid(${r._id})">Marcar Pago</button>
      </td>
    `;
  }

  // Trocar célula por input/select para edição
  window.editRow = function(id){
    const tr = tbody.querySelector(`tr[data-id="${id}"]`); if(!tr) return;
    const map = {
      VENCIMENTO: (v)=> `<input type="date" value="${toISO(v)}" style="width:100%">`,
      EMPRESA: (v)=> `<input value="${escapeHtml(v)}" style="width:100%">`,
      VALOR: (v)=> `<input inputmode="decimal" value="${String(v).replace('.',',')}" style="width:100%">`,
      ACRES: (v)=> `<input inputmode="decimal" value="${String(v||0).replace('.',',')}" style="width:100%">`,
      SALDO: (v)=> `<input inputmode="decimal" value="${String(v||0).replace('.',',')}" style="width:100%">`,
      SITUACAO: (v)=> `<select style="width:100%"><option ${v==='Aberto'?'selected':''}>Aberto</option><option ${v==='Parcial'?'selected':''}>Parcial</option><option ${v==='Pago'?'selected':''}>Pago</option></select>`,
      PAGO: (v)=> `<select style="width:100%"><option ${v==='Não'?'selected':''}>Não</option><option ${v==='Sim'?'selected':''}>Sim</option></select>`,
      QTPARC: (v)=> `<input type="number" min="1" value="${escapeHtml(v||'')}" style="width:100%">`,
      OBS: (v)=> `<input value="${escapeHtml(v||'')}" style="width:100%">`,
      TIPO: (v)=> `<input value="${escapeHtml(v||'')}" style="width:100%">`,
    };
    for(const td of tr.children){
      const k = td.getAttribute('data-k'); if(!k || !map[k]) continue;
      const current = getCellRaw(id,k);
      td.innerHTML = map[k](current);
    }
    const act = tr.querySelector('.actions');
    act.innerHTML = `<button class="btn-mini" onclick="saveRow(${id})">Salvar</button><button class="btn-mini" onclick="cancelEdit(${id})">Cancelar</button>`;
  }

  function toISO(v){
    if(!v) return '';
    const d = (v instanceof Date)? v : parseDate(v);
    if(!d) return '';
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[m]);
  }

  function getRow(id){ return rows.find(r=>r._id===id); }
  function getCellRaw(id,k){
    const r = getRow(id); if(!r) return '';
    if (k==='VENCIMENTO') return r.VENCIMENTO;
    if (k==='VALOR' || k==='ACRES' || k==='SALDO') return r[k];
    return r[k] || '';
  }

  window.saveRow = function(id){
    const tr = tbody.querySelector(`tr[data-id="${id}"]`); if(!tr) return;
    const r = getRow(id); if(!r) return;
    const getVal = (k)=>{
      const td = tr.querySelector(`[data-k="${k}"]`); if(!td) return null;
      const el = td.querySelector('input,select'); if(!el) return null;
      return el.type==='date' ? parseDate(el.value) :
             (el.tagName==='SELECT' ? el.value : el.value);
    };
    const vdt = getVal('VENCIMENTO'); r.VENCIMENTO = vdt instanceof Date? vdt : parseDate(vdt);
    r._ano = r.VENCIMENTO? r.VENCIMENTO.getFullYear():0;
    r._mes = r.VENCIMENTO? r.VENCIMENTO.getMonth()+1:0;
    r.EMPRESA = String(getVal('EMPRESA')||'').trim();
    r.VALOR = toNumber(getVal('VALOR'));
    r.ACRES = toNumber(getVal('ACRES'));
    r.SALDO = toNumber(getVal('SALDO'));
    r.SITUACAO = getVal('SITUACAO')||'';
    r.PAGO = getVal('PAGO')||'';
    r.QTPARC = String(getVal('QTPARC')||'').trim();
    r.OBS = String(getVal('OBS')||'').trim();
    r.TIPO = String(getVal('TIPO')||'').trim();
    saveLocal();
    render();
  }

  window.cancelEdit = function(id){ render(); }

  window.delRow = function(id){
    if (!confirm('Excluir esta linha?')) return;
    rows = rows.filter(r=>r._id!==id);
    saveLocal();
    render();
  }

  window.markPaid = function(id){
    const r = getRow(id); if(!r) return;
    r.SITUACAO='Pago'; r.PAGO='Sim'; r.SALDO=0;
    saveLocal(); render();
  }

  // Adicionar nova linha
  document.getElementById('btnAdd').addEventListener('click', ()=>{
    const iEmpresa = document.getElementById('iEmpresa');
    const iVenc = document.getElementById('iVenc');
    const iValor = document.getElementById('iValor');
    const iAcres = document.getElementById('iAcres');
    const iPago = document.getElementById('iPago');
    const iParc = document.getElementById('iParc');
    const iTipo = document.getElementById('iTipo');
    const iSit = document.getElementById('iSit');
    const iRef = document.getElementById('iRef');
    const iObs = document.getElementById('iObs');

    const dt = iVenc.value ? new Date(iVenc.value+'T12:00:00') : null;
    const obj = {
      _id: id(),
      VENCIMENTO: dt, _ano: dt? dt.getFullYear():0, _mes: dt? dt.getMonth()+1:0,
      EMPRESA: iEmpresa.value.trim(),
      VALOR: toNumber(iValor.value),
      ACRES: toNumber(iAcres.value),
      SALDO: 0,
      SITUACAO: iSit.value,
      PAGO: iPago.value,
      QTPARC: iParc.value.trim(),
      TIPO: iTipo.value.trim(),
      REF: iRef.value.trim(),
      OBS: iObs.value.trim()
    };
    rows.push(obj);
    saveLocal();
    render();
    iValor.value='0'; iAcres.value='0'; iObs.value='';
  });

  // Carregar amostra
  document.getElementById('btnSample').addEventListener('click', ()=>{
    if (!confirm('Carregar amostra? Isso substitui a planilha atual.')) return;
    const mk = (d,e,v,a,s,sit,p,q,o,t,ref)=>({
      _id:id(), VENCIMENTO:new Date(d.split('/').reverse().join('-')+'T12:00:00'),
      _ano:Number(d.split('/')[2]), _mes:Number(d.split('/')[1]),
      EMPRESA:e, VALOR:v, ACRES:a, SALDO:s, SITUACAO:sit, PAGO:p, QTPARC:q, OBS:o, TIPO:t, REF:ref
    });
    rows = [
      mk('05/10/2025','ENERGISA',320.45,0,320.45,'Aberto','Não','1','Conta de energia','Boleto','OUT/2025'),
      mk('10/10/2025','ÁGUA SA',115.90,0,0,'Pago','Sim','1','Fatura água','Débito','OUT/2025'),
      mk('15/10/2025','INTERNET FIBRA',99.99,-10,50,'Parcial','Não','2','Pagamento parcial em 10/10','Pix','OUT/2025'),
    ];
    saveLocal(); render();
  });

  // Limpar planilha
  document.getElementById('btnClear').addEventListener('click', ()=>{ if(!confirm('Limpar toda a planilha?')) return; rows=[]; saveLocal(); render(); });

  // Boot
  (function init(){
    loadLocal();
    if (rows.length===0) {
      // inicia com ano atual no filtro
      const yNow = new Date().getFullYear();
      document.getElementById('fAno').innerHTML = `<option selected>${yNow}</option>`;
    }
    render();
  })();
  </script>
</body>
</html>
